<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strawberry Farm Chat</title>
    <link rel="stylesheet" href="styles.css">
    <!-- ãƒ‡ãƒ¢ç”¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFirebaseè¨­å®šä¸è¦ï¼‰ -->
    <script src="demo-auth.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebaseè¨­å®šï¼ˆå®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebaseè¨­å®šã®æ¤œè¨¼
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || 
            firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error('âš ï¸ Firebaseè¨­å®šãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
            console.error('index.htmlã®firebaseConfigã‚’å®Ÿéš›ã®Firebaseè¨­å®šå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚');
        }

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.googleProvider = googleProvider;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            onAuthStateChanged,
            signOut,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp,
            doc,
            setDoc,
            getDoc,
            getDocs,
            ref,
            uploadBytes,
            getDownloadURL
        };
    </script>
</head>
<body>
    <!-- èªè¨¼ç”»é¢ -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <h1>ğŸ“ Strawberry Farm Chat</h1>
            
            <!-- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="signup-form" class="auth-form">
                <h2>æ–°è¦ç™»éŒ²</h2>
                <input type="text" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                <input type="password" id="signup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" required>
                <input type="text" id="signup-username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required>
                <button onclick="handleSignup()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
                <p class="auth-link">æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ <a href="#" onclick="showLogin()">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div id="login-form" class="auth-form" style="display: none;">
                <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <input type="text" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                <button onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <p class="auth-link">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ <a href="#" onclick="showSignup()">æ–°è¦ç™»éŒ²</a></p>
            </div>

            <!-- Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="google-auth">
                <div class="divider">
                    <span>ã¾ãŸã¯</span>
                </div>
                <button class="google-btn" onclick="handleGoogleLogin()">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.965-2.184l-2.908-2.258c-.806.54-1.837.86-3.057.86-2.35 0-4.34-1.587-5.053-3.72H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.954 10.698c-.18-.54-.282-1.117-.282-1.698s.102-1.158.282-1.698V4.97H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.03l2.997-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.582C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.97L3.954 7.302C4.66 5.167 6.65 3.58 9 3.58z"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>

            <div id="auth-error" class="error-message"></div>
            
            <!-- ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
            <div class="skip-section">
                <button onclick="skipLogin()" class="skip-btn">ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸</button>
            </div>
        </div>
    </div>

    <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆæ©Ÿèƒ½é¸æŠç”»é¢ï¼‰ -->
    <div id="top-page" class="top-page" style="display: none;">
        <div class="top-header">
            <h1>ğŸ“ Strawberry Farm</h1>
            <div class="user-info">
                <span id="top-user-name"></span>
                <button onclick="handleLogout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
        
        <div class="top-content">
            <h2>æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <div class="function-cards">
                <div class="function-card" onclick="showQuestionForm()">
                    <div class="card-icon">ğŸ’¬</div>
                    <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
                    <p>æ–°ã—ã„è³ªå•ã‚’ä½œæˆ</p>
                </div>
                <div class="function-card" onclick="showSettings()">
                    <div class="card-icon">âš™ï¸</div>
                    <h3>å€‹äººè¨­å®š</h3>
                    <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã‚’å¤‰æ›´</p>
                </div>
                <div class="function-card" onclick="alert('ã“ã®æ©Ÿèƒ½ã¯ä»Šå¾Œè¿½åŠ äºˆå®šã§ã™')">
                    <div class="card-icon">ğŸ“Š</div>
                    <h3>ç›¸è«‡å±¥æ­´</h3>
                    <p>éå»ã®ç›¸è«‡å†…å®¹ã‚’ç¢ºèª</p>
                </div>
                <div class="function-card" onclick="alert('ã“ã®æ©Ÿèƒ½ã¯ä»Šå¾Œè¿½åŠ äºˆå®šã§ã™')">
                    <div class="card-icon">ğŸ“</div>
                    <h3>ç›¸è«‡ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <p>æ–°ã—ã„ç›¸è«‡ã‚’é–‹å§‹</p>
                </div>
                <div id="admin-card" class="function-card" onclick="showAdminPage()" style="display: none;">
                    <div class="card-icon">ğŸ‘¨â€ğŸ’¼</div>
                    <h3>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h3>
                    <p>æŠ•ç¨¿ã®ä¸€æ‹¬ç®¡ç†ãƒ»ã‚¿ã‚°ä»˜ã‘</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†è€…ç”¨ãƒšãƒ¼ã‚¸ -->
    <div id="admin-page" class="admin-page" style="display: none;">
        <div class="admin-header">
            <button onclick="showTopPage()" class="back-btn">â† æˆ»ã‚‹</button>
            <h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h2>
        </div>
        
        <div class="admin-content">
            <!-- ã‚¿ã‚°ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="admin-section">
                <h3>ã‚¿ã‚°ç®¡ç†ï¼ˆãƒãƒ£ãƒ—ã‚¿ãƒ¼åï¼‰</h3>
                <div class="tag-management">
                    <div class="tag-input-group">
                        <input type="text" id="new-tag-input" placeholder="æ–°ã—ã„ã‚¿ã‚°ï¼ˆãƒãƒ£ãƒ—ã‚¿ãƒ¼åï¼‰ã‚’è¿½åŠ ">
                        <button onclick="addNewTag()" class="add-tag-btn">è¿½åŠ </button>
                    </div>
                    <div id="tags-list" class="tags-list"></div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="admin-section">
                <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                <div class="filter-controls">
                    <select id="tag-filter" onchange="filterMessages()">
                        <option value="">ã™ã¹ã¦ã®ã‚¿ã‚°</option>
                    </select>
                    <input type="text" id="search-input" placeholder="ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢..." onkeyup="filterMessages()">
                    <button onclick="clearFilters()" class="clear-filter-btn">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤</button>
                </div>
            </div>

            <!-- æŠ•ç¨¿ä¸€è¦§ -->
            <div class="admin-section">
                <h3>æŠ•ç¨¿ä¸€è¦§</h3>
                <div class="messages-controls">
                    <button onclick="selectAllMessages()" class="control-btn">ã™ã¹ã¦é¸æŠ</button>
                    <button onclick="deselectAllMessages()" class="control-btn">é¸æŠè§£é™¤</button>
                    <button onclick="mergeSelectedMessages()" class="control-btn merge-btn">é¸æŠã—ãŸè³ªå•ã‚’çµ±åˆ</button>
                </div>
                <div id="admin-messages-container" class="admin-messages-container"></div>
            </div>
        </div>
    </div>

    <!-- å€‹äººè¨­å®šç”»é¢ -->
    <div id="settings-page" class="settings-page" style="display: none;">
        <div class="settings-header">
            <button onclick="showTopPage()" class="back-btn">â† æˆ»ã‚‹</button>
            <h2>å€‹äººè¨­å®š</h2>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <h3>åŸºæœ¬æƒ…å ±</h3>
                <div class="setting-item">
                    <label for="setting-age">å¹´é½¢</label>
                    <input type="number" id="setting-age" min="1" max="120" placeholder="å¹´é½¢ã‚’å…¥åŠ›">
                </div>
            </div>

            <div class="settings-section">
                <h3>ç›¸è«‡è¨­å®š</h3>
                <div class="setting-item">
                    <label for="setting-consultations-per-day">1æ—¥ã®ç›¸è«‡å›æ•°</label>
                    <select id="setting-consultations-per-day">
                        <option value="1">1å›</option>
                        <option value="2">2å›</option>
                        <option value="3">3å›</option>
                        <option value="4">4å›</option>
                        <option value="5">5å›ä»¥ä¸Š</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>é€šçŸ¥è¨­å®š</h3>
                <div class="setting-item">
                    <label class="toggle-label">
                        <span>è¿”äº‹ãŒæ¥ãŸæ™‚ã®è‡ªå‹•ãƒ¡ãƒ¼ãƒ«é€šçŸ¥</span>
                        <input type="checkbox" id="setting-email-notification" class="toggle-input">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <button onclick="saveSettings()" class="save-btn">è¨­å®šã‚’ä¿å­˜</button>
            <div id="settings-message" class="settings-message"></div>
        </div>
    </div>

    <!-- è³ªå•ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ -->
    <div id="question-form" class="question-form" style="display: none;">
        <div class="question-header">
            <button onclick="showTopPage()" class="back-btn">â† æˆ»ã‚‹</button>
            <h2>ğŸ“ æ–°ã—ã„è³ªå•ã‚’ä½œæˆ</h2>
        </div>
        
        <div class="question-content">
            <div class="form-section">
                <label for="question-category">è³ªå•ã‚«ãƒ†ã‚´ãƒªï¼ˆã„ã¡ã”æ ½åŸ¹ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</label>
                <select id="question-category" required>
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="soil-preparation">åœŸã¥ãã‚Šãƒ»æº–å‚™</option>
                    <option value="planting">æ¤ãˆä»˜ã‘</option>
                    <option value="watering">æ°´ã‚„ã‚Š</option>
                    <option value="fertilization">æ–½è‚¥ãƒ»è‚¥æ–™</option>
                    <option value="temperature">æ¸©åº¦ç®¡ç†</option>
                    <option value="lighting">å…‰ç®¡ç†</option>
                    <option value="pollination">å—ç²‰</option>
                    <option value="pruning">å‰ªå®šãƒ»æ•´æ</option>
                    <option value="pest-control">ç—…å®³è™«å¯¾ç­–</option>
                    <option value="harvesting">åç©«</option>
                    <option value="post-harvest">åç©«å¾Œå‡¦ç†</option>
                    <option value="variety-selection">å“ç¨®é¸ã³</option>
                    <option value="facility-management">æ–½è¨­ç®¡ç†</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>

            <div class="form-section">
                <label for="question-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="question-title" placeholder="è³ªå•ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>

            <div class="form-section">
                <label for="question-text">è³ªå•æ–‡</label>
                <textarea id="question-text" rows="6" placeholder="è©³ã—ãè³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
            </div>

            <div class="form-section">
                <label>ç”»åƒï¼ˆä»»æ„ï¼‰</label>
                <div class="image-upload-area">
                    <label for="question-image-input" class="image-upload-label">
                        <span class="upload-icon">ğŸ“·</span>
                        <span>ç”»åƒã‚’é¸æŠ</span>
                    </label>
                    <input type="file" id="question-image-input" accept="image/*" style="display: none;" onchange="handleQuestionImageSelect(event)">
                    <div id="question-image-preview" class="question-image-preview" style="display: none;">
                        <img id="question-preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                        <button onclick="cancelQuestionImageUpload()" class="cancel-image-btn">Ã—</button>
                    </div>
                </div>
            </div>

            <button onclick="submitQuestion()" class="submit-question-btn">è³ªå•ã‚’é€ä¿¡</button>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
    <div id="chat-container" class="chat-container" style="display: none;">
        <div class="chat-header">
            <button onclick="showTopPage()" class="back-btn">â† æˆ»ã‚‹</button>
            <h2 id="chat-title">ğŸ“ Strawberry Farm Chat</h2>
            <div class="user-info">
                <span id="current-user"></span>
            </div>
        </div>
        
        <div id="chat-status" class="chat-status" style="display: none;">
            <div class="status-message">
                <span class="status-icon">â³</span>
                <span>å•ã„åˆã‚ã›ã¦ã„ã¾ã™ã®ã§ã€ãŠæ™‚é–“ã‚’ãã ã•ã„</span>
            </div>
        </div>
        
        <!-- è³ªå•ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨ç”»åƒã‚’å›ºå®šè¡¨ç¤ºï¼‰ -->
        <div id="question-header" class="question-header-display" style="display: none;">
            <div class="question-header-content">
                <div class="question-header-title" id="question-header-title"></div>
                <div class="question-header-image" id="question-header-image"></div>
            </div>
        </div>
        
        <div id="messages-container" class="messages-container"></div>
        
        <div class="chat-input-container">
            <label for="image-input" class="image-upload-btn" title="ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
                ğŸ“·
            </label>
            <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" class="send-btn">é€ä¿¡</button>
        </div>
        <div id="image-preview" class="image-preview" style="display: none;">
            <img id="preview-img" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
            <button onclick="cancelImageUpload()" class="cancel-image-btn">Ã—</button>
        </div>
        
        <!-- è§£æ±ºã—ã¾ã—ãŸãƒœã‚¿ãƒ³ -->
        <div id="resolve-button-container" class="resolve-button-container" style="display: none;">
            <button onclick="resolveQuestion()" class="resolve-btn">è§£æ±ºã—ã¾ã—ãŸï¼</button>
        </div>
    </div>

    <!-- ç›¸è«‡å±¥æ­´ç”»é¢ -->
    <div id="consultation-history" class="consultation-history" style="display: none;">
        <div class="history-header">
            <button onclick="showTopPage()" class="back-btn">â† æˆ»ã‚‹</button>
            <h2>ğŸ“Š ç›¸è«‡å±¥æ­´</h2>
        </div>
        
        <div class="history-content">
            <div id="history-list" class="history-list">
                <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
