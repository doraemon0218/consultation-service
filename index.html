<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strawberry Farm Chat</title>
    <link rel="stylesheet" href="styles.css">
    <!-- デモ用認証システム（Firebase設定不要） -->
    <script src="demo-auth.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase設定（実際のプロジェクトでは環境変数から取得）
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase設定の検証
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || 
            firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error('⚠️ Firebase設定が正しく設定されていません！');
            console.error('index.htmlのfirebaseConfigを実際のFirebase設定値に置き換えてください。');
        }

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // グローバルに公開
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.googleProvider = googleProvider;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            onAuthStateChanged,
            signOut,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp,
            doc,
            setDoc,
            getDoc,
            getDocs,
            ref,
            uploadBytes,
            getDownloadURL
        };
    </script>
</head>
<body>
    <!-- 認証画面 -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <h1>🍓 Strawberry Farm Chat</h1>
            
            <!-- サインアップフォーム -->
            <div id="signup-form" class="auth-form">
                <h2>新規登録</h2>
                <input type="text" id="signup-email" placeholder="メールアドレス" required>
                <input type="password" id="signup-password" placeholder="パスワード（6文字以上）" required>
                <input type="text" id="signup-username" placeholder="ユーザー名" required>
                <button onclick="handleSignup()">アカウント作成</button>
                <p class="auth-link">既にアカウントをお持ちですか？ <a href="#" onclick="showLogin()">ログイン</a></p>
            </div>

            <!-- ログインフォーム -->
            <div id="login-form" class="auth-form" style="display: none;">
                <h2>ログイン</h2>
                <input type="text" id="login-email" placeholder="メールアドレス" required>
                <input type="password" id="login-password" placeholder="パスワード" required>
                <button onclick="handleLogin()">ログイン</button>
                <p class="auth-link">アカウントをお持ちでないですか？ <a href="#" onclick="showSignup()">新規登録</a></p>
            </div>

            <!-- Googleログインボタン -->
            <div class="google-auth">
                <div class="divider">
                    <span>または</span>
                </div>
                <button class="google-btn" onclick="handleGoogleLogin()">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.965-2.184l-2.908-2.258c-.806.54-1.837.86-3.057.86-2.35 0-4.34-1.587-5.053-3.72H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.954 10.698c-.18-.54-.282-1.117-.282-1.698s.102-1.158.282-1.698V4.97H.957C.348 6.175 0 7.55 0 9s.348 2.825.957 4.03l2.997-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.582C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.97L3.954 7.302C4.66 5.167 6.65 3.58 9 3.58z"/>
                    </svg>
                    Googleでログイン
                </button>
            </div>

            <div id="auth-error" class="error-message"></div>
            
            <!-- スキップボタン -->
            <div class="skip-section">
                <button onclick="skipLogin()" class="skip-btn">スキップしてトップページへ</button>
            </div>
        </div>
    </div>

    <!-- トップページ（機能選択画面） -->
    <div id="top-page" class="top-page" style="display: none;">
        <div class="top-header">
            <h1>🍓 Strawberry Farm</h1>
            <div class="user-info">
                <span id="top-user-name"></span>
                <button onclick="handleLogout()" class="logout-btn">ログアウト</button>
            </div>
        </div>
        
        <div class="top-content">
            <h2>機能を選択してください</h2>
            <div class="function-cards">
                <div class="function-card" onclick="showQuestionForm()">
                    <div class="card-icon">💬</div>
                    <h3>チャット</h3>
                    <p>新しい質問を作成</p>
                </div>
                <div class="function-card" onclick="showSettings()">
                    <div class="card-icon">⚙️</div>
                    <h3>個人設定</h3>
                    <p>アカウント設定を変更</p>
                </div>
                <div class="function-card" onclick="showConsultationHistory()">
                    <div class="card-icon">📊</div>
                    <h3>相談履歴</h3>
                    <p>過去の相談内容を確認</p>
                </div>
                <div class="function-card" onclick="alert('この機能は今後追加予定です')">
                    <div class="card-icon">📝</div>
                    <h3>相談フォーム</h3>
                    <p>新しい相談を開始</p>
                </div>
                <div id="admin-card" class="function-card admin-card-always-visible" onclick="showAdminPage()">
                    <div class="card-icon">👨‍💼</div>
                    <h3>管理者ページ</h3>
                    <p>投稿の一括管理・タグ付け</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理者用ページ -->
    <div id="admin-page" class="admin-page" style="display: none;">
        <div class="admin-header">
            <button onclick="showTopPage()" class="back-btn">← 戻る</button>
            <h2>管理者ページ</h2>
        </div>
        
        <div class="admin-content">
            <!-- タブ切り替え -->
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('management')">管理</button>
                <button class="admin-tab" onclick="switchAdminTab('education')">教育資材</button>
                <button class="admin-tab" onclick="switchAdminTab('settings')">設定</button>
            </div>

            <!-- 管理タブ -->
            <div id="admin-tab-management" class="admin-tab-content active">
                <!-- タグ管理セクション -->
                <div class="admin-section">
                    <h3>タグ管理（チャプター名）</h3>
                    <div class="tag-management">
                        <div class="tag-input-group">
                            <input type="text" id="new-tag-input" placeholder="新しいタグ（チャプター名）を追加">
                            <button onclick="addNewTag()" class="add-tag-btn">追加</button>
                        </div>
                        <div id="tags-list" class="tags-list"></div>
                    </div>
                </div>

                <!-- フィルターセクション -->
                <div class="admin-section">
                    <h3>フィルター</h3>
                    <div class="filter-controls">
                        <select id="tag-filter" onchange="filterMessages()">
                            <option value="">すべてのタグ</option>
                        </select>
                        <input type="text" id="search-input" placeholder="テキスト検索..." onkeyup="filterMessages()">
                        <button onclick="clearFilters()" class="clear-filter-btn">フィルター解除</button>
                    </div>
                </div>

                <!-- 投稿一覧 -->
                <div class="admin-section">
                    <h3>投稿一覧</h3>
                    <div class="messages-controls">
                        <button onclick="selectAllMessages()" class="control-btn">すべて選択</button>
                        <button onclick="deselectAllMessages()" class="control-btn">選択解除</button>
                        <button onclick="mergeSelectedMessages()" class="control-btn merge-btn">選択した質問を統合</button>
                    </div>
                    <div id="admin-messages-container" class="admin-messages-container"></div>
                </div>
            </div>

            <!-- 教育資材タブ -->
            <div id="admin-tab-education" class="admin-tab-content">
                <!-- 統計情報と概要 -->
                <div class="admin-section">
                    <h3>統計情報と質問の特徴</h3>
                    <div id="education-stats" class="education-stats"></div>
                    <div id="question-overview" class="question-overview"></div>
                </div>

                <!-- 質問一覧（全ユーザー） -->
                <div class="admin-section">
                    <h3>すべての質問一覧</h3>
                    <div class="question-list-controls">
                        <div class="filter-group">
                            <select id="category-filter" onchange="filterAllQuestions()">
                                <option value="">すべてのカテゴリ</option>
                                <option value="soil-preparation">土づくり・準備</option>
                                <option value="planting">植え付け</option>
                                <option value="watering">水やり</option>
                                <option value="fertilization">施肥・肥料</option>
                                <option value="temperature">温度管理</option>
                                <option value="lighting">光管理</option>
                                <option value="pollination">受粉</option>
                                <option value="pruning">剪定・整枝</option>
                                <option value="pest-control">病害虫対策</option>
                                <option value="harvesting">収穫</option>
                                <option value="post-harvest">収穫後処理</option>
                                <option value="variety-selection">品種選び</option>
                                <option value="facility-management">施設管理</option>
                                <option value="other">その他</option>
                            </select>
                            <select id="status-filter" onchange="filterAllQuestions()">
                                <option value="">すべてのステータス</option>
                                <option value="resolved">解決済み</option>
                                <option value="admin-notified">対応中</option>
                                <option value="pending">保留中</option>
                            </select>
                            <input type="text" id="question-search" placeholder="質問を検索..." onkeyup="filterAllQuestions()">
                        </div>
                    </div>
                    <div id="all-questions-list" class="all-questions-list"></div>
                </div>

                <!-- チャプター別表示 -->
                <div class="admin-section">
                    <h3>チャプター別整理</h3>
                    <div class="chapter-controls">
                        <select id="chapter-select" onchange="loadChapterContent()">
                            <option value="">チャプターを選択</option>
                        </select>
                        <button onclick="exportEducationMaterial()" class="export-btn">教育資材をエクスポート</button>
                    </div>
                    <div id="chapter-content" class="chapter-content"></div>
                </div>

                <!-- 教育資材プレビュー -->
                <div class="admin-section">
                    <h3>教育資材プレビュー</h3>
                    <div class="education-preview-controls">
                        <button onclick="generateTextbookPreview()" class="preview-btn">教科書形式でプレビュー</button>
                        <button onclick="exportAsMarkdown()" class="export-btn">Markdown形式でエクスポート</button>
                        <button onclick="exportAsPDF()" class="export-btn">PDF形式でエクスポート</button>
                    </div>
                    <div id="education-preview" class="education-preview"></div>
                </div>
            </div>

            <!-- 管理者設定タブ -->
            <div id="admin-tab-settings" class="admin-tab-content">
                <div class="admin-section">
                    <h3>管理者設定</h3>
                    <p class="section-description">管理者の追加・削除、通知設定を行います</p>
                    
                    <!-- 管理者一覧 -->
                    <div class="admin-settings-section">
                        <h4>管理者一覧</h4>
                        <div id="admin-list" class="admin-list"></div>
                        <button onclick="addNewAdmin()" class="add-admin-btn">+ 新しい管理者を追加</button>
                    </div>

                    <!-- 新規管理者追加フォーム -->
                    <div id="new-admin-form" class="new-admin-form" style="display: none;">
                        <h4>新しい管理者を追加</h4>
                        <div class="form-group">
                            <label for="admin-email">メールアドレス</label>
                            <input type="email" id="admin-email" placeholder="admin@example.com" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-notification-type">通知タイプ</label>
                            <select id="admin-notification-type" onchange="updateNotificationOptions()">
                                <option value="realtime">チャットが投稿されるたびに</option>
                                <option value="interval">時間ごと</option>
                            </select>
                        </div>
                        <div class="form-group" id="notification-interval-group" style="display: none;">
                            <label for="admin-notification-interval">通知間隔</label>
                            <select id="admin-notification-interval">
                                <option value="15">15分</option>
                                <option value="30">30分</option>
                                <option value="60">1時間</option>
                                <option value="180">3時間</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button onclick="saveNewAdmin()" class="save-btn">保存</button>
                            <button onclick="cancelAddAdmin()" class="cancel-btn">キャンセル</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 個人設定画面 -->
    <div id="settings-page" class="settings-page" style="display: none;">
        <div class="settings-header">
            <button onclick="showTopPage()" class="back-btn">← 戻る</button>
            <h2>個人設定</h2>
        </div>
        
        <div class="settings-content">
            <div class="settings-section">
                <h3>基本情報</h3>
                <div class="setting-item">
                    <label for="setting-age">年齢</label>
                    <input type="number" id="setting-age" min="1" max="120" placeholder="年齢を入力">
                </div>
            </div>

            <div class="settings-section">
                <h3>相談設定</h3>
                <div class="setting-item">
                    <label for="setting-consultations-per-day">1日の相談回数</label>
                    <select id="setting-consultations-per-day">
                        <option value="1">1回</option>
                        <option value="2">2回</option>
                        <option value="3">3回</option>
                        <option value="4">4回</option>
                        <option value="5">5回以上</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>通知設定</h3>
                <div class="setting-item">
                    <label class="toggle-label">
                        <span>返事が来た時の自動メール通知</span>
                        <input type="checkbox" id="setting-email-notification" class="toggle-input">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <button onclick="saveSettings()" class="save-btn">設定を保存</button>
            <div id="settings-message" class="settings-message"></div>
        </div>
    </div>

    <!-- 質問フォーム画面 -->
    <div id="question-form" class="question-form" style="display: none;">
        <div class="question-header">
            <button onclick="showTopPage()" class="back-btn">← 戻る</button>
            <h2>🍓 新しい質問を作成</h2>
        </div>
        
        <div class="question-content">
            <div class="form-section">
                <label for="question-category">質問カテゴリ（いちご栽培のステップ）</label>
                <select id="question-category" required>
                    <option value="">選択してください</option>
                    <option value="soil-preparation">土づくり・準備</option>
                    <option value="planting">植え付け</option>
                    <option value="watering">水やり</option>
                    <option value="fertilization">施肥・肥料</option>
                    <option value="temperature">温度管理</option>
                    <option value="lighting">光管理</option>
                    <option value="pollination">受粉</option>
                    <option value="pruning">剪定・整枝</option>
                    <option value="pest-control">病害虫対策</option>
                    <option value="harvesting">収穫</option>
                    <option value="post-harvest">収穫後処理</option>
                    <option value="variety-selection">品種選び</option>
                    <option value="facility-management">施設管理</option>
                    <option value="other">その他</option>
                </select>
            </div>

            <div class="form-section">
                <label for="question-title">タイトル</label>
                <input type="text" id="question-title" placeholder="質問のタイトルを入力してください" required>
            </div>

            <div class="form-section">
                <label for="question-text">質問文</label>
                <textarea id="question-text" rows="6" placeholder="詳しく質問内容を入力してください" required></textarea>
            </div>

            <div class="form-section">
                <label>画像（任意）</label>
                <div class="image-upload-area">
                    <label for="question-image-input" class="image-upload-label">
                        <span class="upload-icon">📷</span>
                        <span>画像を選択</span>
                    </label>
                    <input type="file" id="question-image-input" accept="image/*" style="display: none;" onchange="handleQuestionImageSelect(event)">
                    <div id="question-image-preview" class="question-image-preview" style="display: none;">
                        <img id="question-preview-img" src="" alt="プレビュー">
                        <button onclick="cancelQuestionImageUpload()" class="cancel-image-btn">×</button>
                    </div>
                </div>
            </div>

            <button onclick="submitQuestion()" class="submit-question-btn">質問を送信</button>
        </div>
    </div>

    <!-- チャット画面 -->
    <div id="chat-container" class="chat-container" style="display: none;">
        <div class="chat-header">
            <button onclick="showTopPage()" class="back-btn">← 戻る</button>
            <h2 id="chat-title">🍓 Strawberry Farm Chat</h2>
            <div class="user-info">
                <span id="current-user"></span>
            </div>
        </div>
        
        <div id="chat-status" class="chat-status" style="display: none;">
            <div class="status-message">
                <span class="status-icon">⏳</span>
                <span>問い合わせていますので、お時間をください</span>
            </div>
        </div>
        
        <!-- 質問ヘッダー（タイトルと画像を固定表示） -->
        <div id="question-header" class="question-header-display" style="display: none;">
            <div class="question-header-content">
                <div class="question-header-title" id="question-header-title"></div>
                <div class="question-header-image" id="question-header-image"></div>
            </div>
        </div>
        
        <div id="messages-container" class="messages-container"></div>
        
        <div class="chat-input-container">
            <label for="image-input" class="image-upload-btn" title="画像をアップロード">
                📷
            </label>
            <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
            <input type="text" id="message-input" placeholder="メッセージを入力..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" class="send-btn">送信</button>
        </div>
        <div id="image-preview" class="image-preview" style="display: none;">
            <img id="preview-img" src="" alt="プレビュー">
            <button onclick="cancelImageUpload()" class="cancel-image-btn">×</button>
        </div>
        
        <!-- 解決しましたボタン -->
        <div id="resolve-button-container" class="resolve-button-container" style="display: none;">
            <button onclick="resolveQuestion()" class="resolve-btn">解決しました！</button>
        </div>
    </div>

    <!-- 相談履歴画面 -->
    <div id="consultation-history" class="consultation-history" style="display: none;">
        <div class="history-header">
            <button onclick="showTopPage()" class="back-btn">← 戻る</button>
            <h2>📊 相談履歴</h2>
        </div>
        
        <div class="history-content">
            <div id="history-list" class="history-list">
                <!-- 履歴がここに表示されます -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
